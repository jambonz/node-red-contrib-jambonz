<!-- Javascript -->
<script type="text/javascript">
 RED.nodes.registerType('create-call',{
      category: 'jambonz',
      color: '#aebfb9',
      defaults: {
        name: {value: ''},
        server: {value: '', required: true, type: 'jambonz_auth'},
        from: {value: '', required: true},
        fromType: {value: ''},
        to: {value: '', required: true},
        toType: {value: ''},
        dest: {value: 'phone', required: true},
        timeout: {},
        application: {value: '', required: true},
        appName: {}
      },
      inputs:1,
      outputs:1,
      icon: "font-awesome/fa-cubes",
      label: function() { 
        return this.name || 'create call';
      },
      oneditprepare: function() {
        var node = this;
        var destElem = $('#node-input-dest');
        var serverElem = $('#node-input-server');
        var applicationElem = $('#node-input-application');

        $('#node-input-from').typedInput({
          default: $('#node-input-fromType').val(),
          types: ['str','msg', 'flow', 'global', 'jsonata', 'env'],
          typeField: $('#node-input-fromType')
        });
        $('#node-input-to').typedInput({
          default: $('#node-input-toType').val(),
          types: ['str','msg', 'flow', 'global', 'jsonata', 'env'],
          typeField: $('#node-input-toType')
        });


        var populateApplications = function() {
          var serverId = $('#node-input-server option:selected').val();
            $.ajax({
              url: `_jambonz/applications/${serverId}`,
              dataType: 'json',
              timeout: 500,
              error: (err) => {
                console.log(err);
              },
              success: (res) => {
                applicationElem.find('option').remove();
                var options = '';
                res.forEach((app) => {
                  if (node.application === app.application_sid) {
                    options += `<option value="${app.application_sid}" selected>${app.name}</option>`;
                    node.appName = app.name;
                  }
                  else {
                    options += `<option value="${app.application_sid}">${app.name}</option>`;
                  }
                });
                if (options.length) applicationElem.append(options);
              }
            });
          }
        serverElem.change(populateApplications);
        applicationElem.change(() => {
          node.appName = $('#node-input-application option:selected').text();
        });
      }
  });
</script>


<!-- HTML -->
<script type="text/html" data-template-name="create-call">
    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server">Server</label>
    <input type="text" id="node-input-server">
  </div>
  <div class="form-row">
    <label for="node-input-from">From</label>
    <input type="text" id="node-input-from" placeholder="calling party number">
    <input type="hidden" id="node-input-fromType">
  </div>
  <div class="form-row">
    <label for="node-input-to">To</label>
    <input type="text" id="node-input-to" placeholder="called party info">
    <input type="hidden" id="node-input-toType">
  </div>
  <div class="form-row">
    <label for="node-input-dest">Call type</label>
    <select id="node-input-dest">
      <option value="phone">phone number</option>
      <option value="user">registered sip device/user</option>
      <option value="sip">sip endpoint</option>
      <option value="ms-teams">Microsoft teams</option>
    </select>
  </div>
  <div class="form-row">
    <label for="node-input-timeout">Ring timeout</label>
    <input type="text" id="node-input-timeout" placeholder="ring no answer timeout in secs (default: 60)">
    <input type="hidden" id="node-input-timeoutType">
  </div>
  <div class="form-row">
    <label for="node-input-application">Application</label>
    <select id="node-input-application">
    </select>
  </div>
  
  </script>

<!-- Help Text -->

<script type="text/html" data-help-name="create-call">
  <p>Create an outbound call</p>
  <h3>Properties</h3>
    <p><code>Server</code> -jambonz server to connect to</p>
    <p><code>From</code> - Calling party phone number</p>
    <p><code>To</code> - Called party phone number, or other identifier</p>
    <p><code>Call type</code> - Type of destination: phone number, registered user, sip endpoint, or microsoft teams</p>
    <p><code>Application</code> - Application to execute when call is answered</p>
  
  <h3>Outputs</h3>
  <dl class="message-properties">
   <dt>statusCode<span class="property-type">int</span></dt>
   <dd> <code>msg.statusCode</code> will contain the response code from Jambomnz to the createCall request</dd>
   <dt>callSid<span class="property-type">string</span></dt>
   <dd> <code>msg.callSid</code> will contain the SID of the call that was created</dd>
  </dl>
  
  <h3>Details</h3>
  The create call command is used to generate a new outbound call.  
  When the call is answered the specified application's call hook will be invoked.
  <h3>References</h3>
    <ul>
        <li><a href="https://docs.jambonz.org/rest/#create-a-call">Jambonz reference</a></li>
    </ul>
  </script>
